(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[544],{12769:function(){},35883:function(){},52361:function(){},94616:function(){},65005:function(){},15130:function(){},49879:function(){},48707:function(e,t,n){"use strict";n.d(t,{$:function(){return i},f:function(){return c}});var r=n(3827),s=n(64090),o=n(24370),a={src:"/_next/static/media/etherlinkLogo.5b44e59c.webp"};let i=e=>{let t=void 0===e.name?e.isTezos?"Tezos":"Etherlink":e.name;return(0,r.jsxs)("span",{className:"flex items-center",children:[e.isTezos?(0,r.jsx)(o.f,{className:"inline w-6 h-6 p-1 mr-1 bg-white rounded-full"}):(0,r.jsx)("img",{src:a.src,alt:"Etherlink Logo",className:"inline w-6 h-6 mr-1 rounded-full"}),t&&(0,r.jsx)("span",{children:t})]})},c=(0,s.memo)(i)},24370:function(e,t,n){"use strict";n.d(t,{x:function(){return o},f:function(){return s}});var r=n(3827);let s=e=>(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 47 64",...e,children:(0,r.jsx)("path",{fill:"#2C7DF7",d:"M30.252 63.441c-4.55 0-7.864-1.089-9.946-3.267-2.08-2.177-3.121-4.525-3.121-7.041 0-.92.181-1.694.544-2.323a3.993 3.993 0 0 1 1.489-1.489c.629-.363 1.403-.544 2.323-.544.92 0 1.693.181 2.323.544.629.363 1.125.86 1.488 1.489.363.629.544 1.403.544 2.323 0 1.113-.266 2.02-.798 2.722-.533.702-1.162 1.161-1.888 1.38.63.87 1.622 1.487 2.977 1.85 1.355.388 2.71.581 4.065.581 1.887 0 3.593-.508 5.118-1.524 1.524-1.017 2.65-2.517 3.376-4.501.726-1.984 1.089-4.235 1.089-6.752 0-2.734-.4-5.07-1.198-7.005-.775-1.96-1.924-3.412-3.449-4.356a9.21 9.21 0 0 0-4.936-1.415c-1.162 0-2.613.484-4.356 1.452l-3.194 1.597v-1.597L37.076 16.4H17.185v19.89c0 1.646.363 3.001 1.089 4.066s1.839 1.597 3.34 1.597c1.16 0 2.274-.387 3.339-1.162a11.803 11.803 0 0 0 2.758-2.83c.097-.219.218-.376.363-.473a.723.723 0 0 1 .472-.181c.266 0 .58.133.944.4.339.386.508.834.508 1.342a9.243 9.243 0 0 1-.182 1.017c-.822 1.839-1.96 3.242-3.412 4.21a8.457 8.457 0 0 1-4.79 1.452c-4.308 0-7.285-.847-8.93-2.54-1.645-1.695-2.468-3.994-2.468-6.897V16.4H.052v-3.703h10.164v-8.42L7.893 1.952V.066h6.751l2.54 1.306v11.325l26.28-.072 2.614 2.613-16.116 16.116a10.807 10.807 0 0 1 3.049-.726c1.742 0 3.702.557 5.88 1.67 2.202 1.089 3.896 2.59 5.081 4.5 1.186 1.888 1.948 3.703 2.287 5.445.363 1.743.545 3.291.545 4.646 0 3.098-.654 5.977-1.96 8.64-1.307 2.661-3.291 4.645-5.953 5.952-2.662 1.307-5.542 1.96-8.639 1.96z"})}),o=e=>(0,r.jsxs)("svg",{className:e.className,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,r.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,r.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})},73983:function(e,t,n){"use strict";n.d(t,{v:function(){return o}});let r=n(49079).env.NEXT_PUBLIC_APP_URL||window.location.origin,s="oxfordnet",o={isTestnet:!0,isMock:!1,app:{name:"Tez2Eth",description:"",url:r},bridge:{smartRollupAddress:"sr1T4XVcVtBRzYy52edVTdgup9Kip4Wrmn97",smartRollupNodeBaseUrl:"https://etherlink-rollup-oxford.dipdup.net"},tezos:{network:{name:s,displayName:s[0].toLocaleUpperCase()+s.slice(1),rpcUrl:"https://rpc.tzkt.io/".concat(s)}},etherlink:{network:{name:"Etherlink Testnet",displayName:"Etherlink Testnet",chainId:1337,nativeCurrency:{name:"XTZ",symbol:"XTZ",decimals:18},rpcUrl:"https://etherlink.dipdup.net",blockExplorerUrl:"https://blockscout.dipdup.net"}},providers:{dipDup:{baseUrl:"https://etherlink-bridge-indexer.dipdup.net",webSocketApiBaseUrl:"wss://etherlink-bridge-indexer.dipdup.net"},tzKT:{baseUrl:"https://api.".concat(s,".tzkt.io")}},walletConnectProjectId:"734c08921b9f4f202d6b63a45fb0d800"}},85021:function(e,t,n){"use strict";n.d(t,{EP:function(){return o.useEtherlinkAccount},LI:function(){return r.useIsomorphicLayoutEffect},Mw:function(){return a.useTezosAccount},SH:function(){return i.useTokenTransfersStoreContext},bp:function(){return s.useAppContext}});var r=n(22632),s=n(55836),o=n(99824),a=n(88963),i=n(10018)},55836:function(e,t,n){"use strict";n.r(t),n.d(t,{AppContextProvider:function(){return i},useAppContext:function(){return c}});var r=n(3827),s=n(64090);let o=async()=>{try{return new(await Promise.all([n.e(632),n.e(813),n.e(877),n.e(101),n.e(546)]).then(n.bind(n,32652))).App}catch(e){return null}},a=(0,s.createContext)(null),i=e=>{let[t,n]=(0,s.useState)(null);return(0,s.useEffect)(()=>{o().then(n)},[]),(0,r.jsx)(a.Provider,{value:t,children:e.children})},c=()=>(0,s.useContext)(a)},99824:function(e,t,n){"use strict";n.r(t),n.d(t,{EtherlinkAccountProvider:function(){return p},useEtherlinkAccount:function(){return g}});var r=n(3827),s=n(64030),o=n(64090),a=n(55836),i=n(73983),c=n(24668),l=n(89521);let d={connectionStatus:c.R.NotConnected,address:void 0,connect:l.PL,switchNetwork:l.PL,disconnect:l.PL},u=(e,t)=>e?t===i.v.etherlink.network.chainId?c.R.Connected:c.R.SwitchNetwork:c.R.NotConnected,h=(0,o.createContext)(d),p=e=>{let t=(0,a.useAppContext)(),{address:n,chainId:c,isConnected:l}=(0,s.Zc)(),[p,g]=(0,o.useState)(d),{walletProvider:k}=(0,s.B0)();return(0,o.useEffect)(()=>{(null==t?void 0:t.web3Modal)&&g({address:d.address,connectionStatus:d.connectionStatus,async connect(){await t.web3Modal.open()},async switchNetwork(){await t.web3Modal.switchNetwork(i.v.etherlink.network.chainId)},async disconnect(){await t.web3Modal.disconnect()}})},[null==t?void 0:t.web3Modal]),(0,o.useEffect)(()=>g(e=>({...e,address:n,connectionStatus:u(l,c)})),[n,c,l]),(0,o.useEffect)(()=>{(null==t?void 0:t.etherlinkToolkit)&&t.etherlinkToolkit.setProvider(k)},[null==t?void 0:t.etherlinkToolkit,k]),(0,r.jsx)(h.Provider,{value:p,children:e.children})},g=()=>(0,o.useContext)(h)},22632:function(e,t,n){"use strict";n.r(t),n.d(t,{useIsomorphicLayoutEffect:function(){return r}});let r=n(64090).useLayoutEffect},88963:function(e,t,n){"use strict";n.r(t),n.d(t,{TezosAccountProvider:function(){return d},useTezosAccount:function(){return u}});var r=n(3827),s=n(64090),o=n(55836),a=n(24668),i=n(89521);let c={connectionStatus:a.Z.NotConnected,address:void 0,connect:i.PL,disconnect:i.PL},l=(0,s.createContext)(c),d=e=>{let t=(0,o.useAppContext)(),[n,i]=(0,s.useState)(c),d=null==t?void 0:t.beaconTezosWallet;return(0,s.useEffect)(()=>{i(d?{connectionStatus:a.Z.NotConnected,address:void 0,connect:async()=>{try{let{address:e}=await d.requestPermissions();return i(t=>({...t,connectionStatus:e?a.Z.Connected:a.Z.NotConnected,address:e})),e}catch(e){return}},disconnect:()=>(i(e=>({...e,connectionStatus:a.Z.NotConnected,address:void 0})),d.disconnect())}:c)},[d]),(0,s.useEffect)(()=>{if(!d)return;let e=async()=>{try{let e=await d.getActiveAccount(),t=null==e?void 0:e.address;i(e=>({...e,connectionStatus:t?a.Z.Connected:a.Z.NotConnected,address:t}))}catch(e){console.error(e)}};d.subscribeToEvent("ACTIVE_ACCOUNT_SET",async e=>{let{address:t}=e,n=t?a.Z.Connected:a.Z.NotConnected;i(e=>e.address===t&&e.connectionStatus===n?e:{...e,connectionStatus:n,address:t}),console.log("Tezos account changed",t)}),e()},[d]),(0,r.jsx)(l.Provider,{value:n,children:e.children})},u=()=>(0,s.useContext)(l)},10018:function(e,t,n){"use strict";n.r(t),n.d(t,{TokenTransfersStoreContextProvider:function(){return c},useTokenTransfersStoreContext:function(){return l}});var r=n(3827),s=n(56842),o=n(64090);let a=(e,t)=>{switch(t.type){case"loaded":{let n=new Map(e);return t.payload.forEach(e=>n.set(s.P6.getInitialOperationHash(e),e)),n}case"added-or-updated":{let n=new Map(e);return n.set(s.P6.getInitialOperationHash(t.payload),t.payload),n}}},i=(0,o.createContext)(null),c=e=>{let[t,n]=(0,o.useReducer)(a,new Map),s=(0,o.useMemo)(()=>({tokenTransfers:t,dispatch:n}),[t,n]);return(0,r.jsx)(i.Provider,{value:s,children:e.children})},l=()=>(0,o.useContext)(i)},24668:function(e,t,n){"use strict";var r,s,o,a;n.d(t,{R:function(){return s},Z:function(){return r}}),(o=r||(r={}))[o.NotConnected=0]="NotConnected",o[o.Connected=10]="Connected",(a=s||(s={}))[a.NotConnected=0]="NotConnected",a[a.SwitchNetwork=1]="SwitchNetwork",a[a.Connected=10]="Connected"},59588:function(e,t,n){"use strict";n.r(t),n.d(t,{ExplorerType:function(){return a},LinkType:function(){return o},getExplorerUrl:function(){return l},getTokenExplorerUrl:function(){return d}});var r,s,o,a,i=n(73983);(r=o||(o={}))[r.Address=0]="Address",r[r.Operation=1]="Operation",r[r.Token=2]="Token",(s=a||(a={}))[s.TzKT=0]="TzKT",s[s.BCD=1]="BCD",s[s.Blockscout=2]="Blockscout";let c={0:"https://".concat(i.v.tezos.network.name,".tzkt.io"),1:"https://better-call.dev/".concat(i.v.tezos.network.name),2:i.v.etherlink.network.blockExplorerUrl},l=(e,t,n)=>{let r=c[n=null!=n?n:e.startsWith("0x")?2:0];return 2===n?"".concat(r,"/").concat(0===t?"address":"tx","/").concat(e):"".concat(r,"/").concat(e)},d=(e,t)=>{let n=c[t=null!=t?t:e.address.startsWith("0x")?2:0];switch(t){case 0:return"".concat(n,"/").concat(e.address,"/tokens/").concat(e.tokenId||"0");case 2:return"".concat(n,"/token/").concat(e.address);case 1:return"".concat(n,"/").concat(e.address)}}},89521:function(e,t,n){"use strict";n.d(t,{Yz:function(){return T},Nn:function(){return v.Z},PL:function(){return w},Bi:function(){return y},e$:function(){return C},sG:function(){return r},S9:function(){return s},Dc:function(){return m},el:function(){return o}});var r={};n.r(r),n.d(r,{capitalize:function(){return a},getShortText:function(){return d},padEnd:function(){return l},padStart:function(){return c}});var s={};n.r(s),n.d(s,{convertTokensAmountToRawAmount:function(){return g},convertTokensRawAmountToAmount:function(){return k},truncateTokensAmountToDecimals:function(){return h}});var o={};n.r(o),n.d(o,{isUserAbortedWalletError:function(){return f}});let a=e=>{var t;return e&&(null===(t=e[0])||void 0===t?void 0:t.toLocaleUpperCase())+e.slice(1)},i=function(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:" ";if(void 0!==String.prototype.padStart)return e.padStart(n,r);let s=e.length;if(n<=s||""==r)return e;let o=n-s,a=r.repeat(Math.ceil(o/r.length));return a.length>o&&(a=a.slice(0,o)),t?a+e:e+a},c=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:" ";return void 0!==String.prototype.padStart?e.padStart(t,n):i(e,!0,t,n)},l=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:" ";return void 0!==String.prototype.padEnd?e.padEnd(t,n):i(e,!1,t,n)},d=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t;return"".concat(e.substring(0,t),"..").concat(e.substring(e.length-n))},u=e=>{for(let t=e.length-1;t>=0;t--){let n=e[t];if("."===n||","===n)return t}return -1},h=(e,t)=>{let n=u(e);if(-1===n)return e;let r=e.substring(0,n);return t?r+e.substring(n,n+1+t):r},p=/[^0-9]/g,g=(e,t)=>{try{let n=h(e,t),r=u(n),s=t&&-1!==r&&r!==n.length-1?t-(n.length-r-1):t,o=BigInt(10**s),a=n.replace(p,"");return BigInt(a)*o}catch(e){return console.error(e),null}},k=(e,t)=>{let n=e.toString(10);if(!t)return n;let r=n.length-t,s=r>0?n.substring(0,r)+"."+n.substring(r):"0."+c(n,t,"0"),o=-1;for(let e=s.length-1;e>=0;e--){let t=s[e];if("."===t||","===t){o=e-1;break}if("0"!==t){o=e;break}}return o>-1?s.substring(0,o+1):s};var T=n(59588),b=n(24227);let f=e=>{var t,n;return void 0!==e&&(e instanceof b.Rd||4001===e.code||(null===(t=e.error)||void 0===t?void 0:t.code)===4001||(null===(n=e.innerError)||void 0===n?void 0:n.code)===4001)};var v=n(75504);let m=e=>new Promise(t=>setTimeout(t,e)),y=()=>{},w=async()=>{},C=e=>"string"==typeof(null==e?void 0:e.message)?e.message:"string"==typeof e?e:"Unknown error"},56842:function(e,t,n){"use strict";n.d(t,{$z:function(){return te},P6:function(){return H},gt:function(){return e7},gu:function(){return q},hj:function(){return j},in:function(){return eu},uF:function(){return tt},vp:function(){return en},wy:function(){return e9},xh:function(){return es},xz:function(){return eA}});var r,s,o,a=n(97882),i=n(15365),c=n(4170),l=n(55549),d=n(27725),u=n(13021),h=Object.defineProperty,p=(e,t,n)=>t in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,g=(e,t)=>{for(var n in t)h(e,n,{get:t[n],enumerable:!0})},k=(e,t,n)=>(p(e,"symbol"!=typeof t?t+"":t,n),n),T=class extends Error{constructor(e,t){super(e,t),k(this,"name"),this.name=this.constructor.name}},b=class extends Error{},f=class e extends T{static getMessage(e,t){return"Response Error [Code: ".concat(e,"]. Content = ").concat(t)}constructor(t,n){super(e.getMessage(t,n))}},v=(e,t)=>e===t,m=(e,t,n)=>{if(null===t||null===n||t.length!==n.length)return!1;let r=t.length;for(let s=0;s<r;s++)if(!e(t[s],n[s]))return!1;return!0},y=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:v,n=null,r=null;return function(){return m(t,n,arguments)||(r=e.apply(null,arguments)),n=arguments,r}},w={};g(w,{isArray:()=>C,isDisposable:()=>A,isReadonlyArray:()=>D});var C=e=>Array.isArray(e),D=e=>Array.isArray(e),A=e=>"function"==typeof(null==e?void 0:e[Symbol.dispose]),_={};g(_,{trimSlashes:()=>B});var B=e=>{let t=e.startsWith("/"),n=e.endsWith("/");return t&&n?e.slice(1,-1):t?e.slice(1):n?e.slice(0,-1):e},S={};g(S,{convertAddressToBytes:()=>P,convertBytesToAddress:()=>z,getOperationTotalCost:()=>x});var P=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=(0,a.aZ)(e);return t?"0x"+n:n},z=e=>(e.startsWith("0x")&&(e=e.substring(2)),(0,a.W0)(e)),x=y(e=>e.fee+250*Number.parseInt(e.storageDiff)),L={};g(L,{isTezosToken:()=>N,toDisplayString:()=>O});var N=e=>"native"===e.type||"fa1.2"===e.type||"fa2"===e.type,E=e=>{if(!e)return"[token is ".concat(null===e?"null":"undefined","]");switch(e.type){case"native":return"[native token]";case"erc20":return"[".concat(e.address," | ERC-20]");case"fa1.2":return"[".concat(e.address," | FA1.2]");case"fa2":return"[".concat(e.address," | FA2 | Id: ").concat(e.tokenId,"]");default:return"[unknown token type]"}},I=e=>e.reduce((e,t,n,r)=>e+E(t)+(n<r.length-1?", ":"]"),"["),O=e=>D(e)?I(e):E(e),W={};g(W,{isAddress:()=>R,isTransaction:()=>M,prepareHexPrefix:()=>Q,toChecksumAddress:()=>U});var R=e=>c.UJ(e,!0),F=/^0x[0-9a-f]{64}$/,M=e=>F.test(e),U=e=>i.P6Y.toChecksumAddress(e),Q=(e,t)=>e.startsWith("0x")?t?e:e.substring(2):t?"0x"+e:e,H={};g(H,{getInitialOperation:()=>G,getInitialOperationHash:()=>V,isBridgeTokenTransferOwner:()=>Z,parseBridgeTokenTransfer:()=>Y,stringifyBridgeTokenTransfer:()=>X});var q=((r=q||{})[r.Deposit=0]="Deposit",r[r.Withdrawal=1]="Withdrawal",r[r.DepositRevert=2]="DepositRevert",r[r.WithdrawalRevert=3]="WithdrawalRevert",r),j=((s=j||{})[s.Pending=0]="Pending",s[s.Created=100]="Created",s[s.Sealed=200]="Sealed",s[s.Finished=300]="Finished",s[s.Failed=400]="Failed",s),G=e=>0===e.kind?e.tezosOperation:e.etherlinkOperation,V=e=>0===e.kind?e.tezosOperation.hash:e.etherlinkOperation.hash,Z=(e,t)=>e.source===t||e.receiver===t,K=["tezosOperation","etherlinkOperation"],J=["amount","fee"],$=(e,t)=>"bigint"==typeof t?t.toString(10):t,X=(e,t)=>{try{return JSON.stringify(e,$,t)}catch(e){return""}},Y=e=>{try{let t=JSON.parse(e);for(let e of K)if(t[e])for(let n of J)t[e][n]&&(t[e][n]=BigInt(t[e][n]));return t}catch(e){return null}},ee=()=>{},et=class{getUrl(e){return new URL(this.baseUrl+"/"+_.trimSlashes(e))}async getRequestInit(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=new Headers(e.headers);return t.has("Accept")||t.append("Accept","application/json"),t.has("Content-Type")||t.append("Content-Type","application/json"),e.headers=t,e}async fetch(e,t,n){let r=!(arguments.length>3)||void 0===arguments[3]||arguments[3];r&&(n=await this.getRequestInit(n));let s="string"==typeof e?this.getUrl(e):e,o=await fetch(s.href,n);return await this.ensureResponseOk(o),"none"===t?void 0:await ("json"===t?o.json():o.text())}async ensureResponseOk(e){let t;if(!e.ok){try{t=await e.text()}catch(e){t="[unavailable]"}throw new f(e.status,t)}}constructor(e){k(this,"baseUrl"),this.baseUrl=_.trimSlashes(e)}},en=class{addListener(e){return this.listeners.add(e),this}removeListener(e){return this.listeners.has(e)&&this.listeners.delete(e),this}removeAllListeners(){return this.listeners=new Set,this}emit(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];this.listeners.size&&(1===this.listeners.size?this.listeners.values().next().value(...t):[...this.listeners].forEach(e=>e(...t)))}constructor(){k(this,"listeners",new Set)}},er=class{get counter(){return this._counter}set counter(e){this._counter=e}[Symbol.dispose](){this.counterExpirationWatcherId&&clearTimeout(this.counterExpirationWatcherId),this.actionWatchers.forEach(e=>clearTimeout(e))}setTimeout(e){return new Promise(t=>{this.counterExpirationMs&&this.resetCounterExpiration();let n=Math.min(this.counter,this.timeouts.length-1),r=setTimeout(async()=>{this.actionWatchers.delete(r),clearTimeout(r),await e(),t()},this.timeouts[n]);this.actionWatchers.add(r),this.counter++})}resetCounter(){this.counter=0}resetCounterExpiration(){this.counterExpirationWatcherId&&clearTimeout(this.counterExpirationWatcherId),this.counterExpirationWatcherId=setTimeout(()=>{this.resetCounter(),this.counterExpirationWatcherId=void 0},this.counterExpirationMs)}constructor(e,t){this.timeouts=e,this.counterExpirationMs=t,k(this,"counterExpirationWatcherId"),k(this,"actionWatchers",new Set),k(this,"_counter",0)}},es=class{getRegisteredTokenPair(e){var t,n,r;return Promise.resolve(("native"===e.type?this.tokenPairsByTokenMap[e.type]:"fa1.2"===e.type||"erc20"===e.type?null===(t=this.tokenPairsByTokenMap[e.type])||void 0===t?void 0:t[e.address]:"fa2"===e.type?null===(r=this.tokenPairsByTokenMap[e.type])||void 0===r?void 0:null===(n=r[e.address])||void 0===n?void 0:n[e.tokenId]:null)||null)}getRegisteredTokenPairs(e,t){return Promise.resolve(this.tokenPairs.slice(e,t&&t+(e||0)))}createTokenPairsByTokenMap(e){let t={};for(let n of e)"native"===n.tezos.type?t.native=n:(t[n.tezos.type]||(t[n.tezos.type]={}),"fa1.2"===n.tezos.type?t[n.tezos.type][n.tezos.address]=n:(t[n.tezos.type][n.tezos.address]||(t[n.tezos.type][n.tezos.address]={}),t[n.tezos.type][n.tezos.address][n.tezos.tokenId]=n)),"native"!==n.etherlink.type&&(t[n.etherlink.type]||(t[n.etherlink.type]={}),"erc20"===n.etherlink.type&&(t[n.etherlink.type][n.etherlink.address]=n));return t}constructor(e){this.tokenPairs=e,k(this,"tokenPairsByTokenMap"),this.tokenPairsByTokenMap=this.createTokenPairsByTokenMap(e)}},eo=class extends T{constructor(e){super("TzKT won't be able to receive a balance of the ".concat(L.toDisplayString(e),") token. Only Tezos tokens."))}},ea=e=>e?"string"==typeof e?e:"string"==typeof(null==e?void 0:e.message)?e.message:"[unknown error type]":"[error is ".concat(null===e?"null":"undefined","]"),ei=L.toDisplayString,ec=e=>"Bridge Token transfer is ".concat(null===e?"null":"undefined"),el=e=>{var t,n;return e?"Bridge Token Transfer:\n  Kind: ".concat(q[e.kind],"\n  Status: ").concat(j[e.status],"\n  Source: ").concat(e.source,"\n  Receiver: ").concat(e.receiver,"\n  Tezos operation hash: ").concat(null==e?void 0:null===(t=e.tezosOperation)||void 0===t?void 0:t.hash,"\n  Etherlink operation hash: ").concat(null==e?void 0:null===(n=e.etherlinkOperation)||void 0===n?void 0:n.hash,"\n\n"):ec(e)},ed=e=>e?"Bridge Token Transfer [".concat(H.getInitialOperationHash(e),"]:\n\n").concat(H.stringifyBridgeTokenTransfer(e,2),"\n\n"):ec(e),eu=((o=eu||{})[o.None=0]="None",o[o.Debug=1]="Debug",o[o.Information=2]="Information",o[o.Warning=3]="Warning",o[o.Error=4]="Error",o),eh=e=>({debug:e,log:e,warn:e,error:e,time:e,timeEnd:e,timeLog:e}),ep=eh(ee),eg=eh(null),ek=y(e=>({debug:e.debug,log:e.log,warn:e.warn,error:e.error,time:e.time,timeEnd:e.timeEnd,timeLog:e.timeLog})),eT=e=>y(t=>({debug:e,log:t.log,warn:t.warn,error:t.error,time:t.time,timeEnd:t.timeEnd,timeLog:t.timeLog})),eb=eT(ee),ef=eT(null),ev=e=>y(t=>({debug:e,log:e,warn:t.warn,error:t.error,time:e,timeEnd:e,timeLog:e})),em=ev(ee),ey=ev(null),ew=e=>y(t=>({debug:e,log:e,warn:e,error:t.error,time:e,timeEnd:e,timeLog:e})),eC=ew(ee),eD=ew(null),eA=new class{get logger(){return this._logger}get lazyLogger(){return this._lazyLogger}get logLevel(){return this._logLevel}setLogger(e){this.internalLogger=e,this.updateLogger()}setLogLevel(e){this._logLevel=e,this.updateLogger()}updateLogger(){switch(this._logLevel){case 0:this._logger=ep,this._lazyLogger=eg;break;case 1:this._logger=ek(this.internalLogger),this._lazyLogger=ek(this.internalLogger);break;case 2:this._logger=eb(this.internalLogger),this._lazyLogger=ef(this.internalLogger);break;case 3:this._logger=em(this.internalLogger),this._lazyLogger=ey(this.internalLogger);break;case 4:this._logger=eC(this.internalLogger),this._lazyLogger=eD(this.internalLogger)}}constructor(e,t){k(this,"internalLogger"),k(this,"_logLevel",2),k(this,"_logger",ep),k(this,"_lazyLogger",eg),this.internalLogger=e,this._logLevel=t,this.updateLogger()}}(console,0),e_=e=>{var t,n;return!!(e&&(null===(t=e.account)||void 0===t?void 0:t.address)&&e.token&&(null===(n=e.token.contract)||void 0===n?void 0:n.address)&&("fa1.2"===e.token.standard||"fa2"===e.token.standard))},eB=e=>({token:"fa2"===e.token.standard?{type:e.token.standard,address:e.token.contract.address,tokenId:e.token.tokenId||"0"}:{type:e.token.standard,address:e.token.contract.address},balance:e.balance?BigInt(e.balance):0n}),eS=e=>{try{let t;let n=[];for(let r of e){if(!e_(r))continue;let e=eB(r);n.push(e),t=r.account.address}return t&&n.length?{address:t,tokenBalances:n}:null}catch(e){return eA.logger.error("Token Balances DTOs mapping error.",ea(e)),null}},eP=e=>{try{if(!e_(e[0]))return null;let t=eB(e[0]);return t.address=e[0].account.address,t}catch(e){return eA.logger.error("Token Balance DTOs mapping error.",ea(e)),null}},ez=class e extends et{async getBalance(e,t){var n,r,s,o;if(!L.isTezosToken(t)){let e=new eo(t);throw eA.logger.error(e),e}null===(n=(r=eA.lazyLogger).log)||void 0===n||n.call(r,"Getting balance of the ".concat(ei(t)," token for the ").concat(e," address"));let a=await ("native"===t.type?this.getNativeTezosTokenAccountBalance(e,!1):this.getNonNativeTezosTokenBalance(e,t));return null===(s=(o=eA.lazyLogger).log)||void 0===s||s.call(o,"The balance of the ".concat(ei(t)," token for the ").concat(e," address is ").concat(a.balance)),a}async getBalances(e,t,n){return"number"!=typeof t&&t?this.getTezosTokenBalances(e,t):this.getAllTokenBalances(e,t,n)}async getAllTokenBalances(e,t,n){let r;if(eA.logger.log("Getting balances of the all tokens for the ".concat(e," address")),t)r=await this.getNonNativeTezosTokenBalances(e,null,t,n);else{let[s,o]=await Promise.all([this.getNativeTezosTokenAccountBalance(e,!0),this.getNonNativeTezosTokenBalances(e,null,t,n)]);(r=o).tokenBalances.unshift(s.tokenBalances[0])}return eA.logger.log("The balances of the all tokens for the ".concat(e," address has been received")),r}async getTezosTokenBalances(e,t){var n,r,s,o;let a,i,c;let{nativeToken:l,nonNativeTezosTokens:d}=this.splitTokensToNativeAndNonNativeTokens(t);return null===(n=(r=eA.lazyLogger).log)||void 0===n||n.call(r,"Getting balances of the ".concat(ei(t)," tokens for the ").concat(e," address")),l&&d.length>1?[i,c]=await Promise.all([this.getNativeTezosTokenAccountBalance(e,!0),this.getNonNativeTezosTokenBalances(e,d)]):l?i=await this.getNativeTezosTokenAccountBalance(e,!0):c=await this.getNonNativeTezosTokenBalances(e,d),i&&c?(a=c).tokenBalances.unshift(i.tokenBalances[0]):a=i||c,null===(s=(o=eA.lazyLogger).log)||void 0===s||s.call(o,"The balances of the ".concat(ei(t)," tokens for the ").concat(e," address has been received")),a}async getNonNativeTezosTokenBalance(e,t){let n=decodeURIComponent(this.getNonNativeTezosTokenBalancesQueryParams(e,t).toString()),r=await this.fetch("/v1/tokens/balances?".concat(n),"json");eA.logger.debug("Mapping the tokenBalanceDTOs to AccountTokenBalances...");let s=eP(r);return eA.logger.debug("Mapping has been completed."),s||{address:e,token:t,balance:0n}}async getNonNativeTezosTokenBalances(t,n,r,s){let o=this.getNonNativeTezosTokenBalancesQueryParams(t,n);r&&r>0&&o.append("offset",r.toString()),s&&s>0&&s<e.defaultLoadDataLimit&&o.append("limit",s.toString());let a=decodeURIComponent(o.toString()),i=await this.fetch("/v1/tokens/balances?".concat(a),"json");eA.logger.debug("Mapping the tokenBalanceDTOs to AccountTokenBalances...");let c=eS(i);return eA.logger.debug("Mapping has been completed."),c||{address:t,tokenBalances:[]}}async getNativeTezosTokenAccountBalance(e,t){let n=await this.fetch("/v1/accounts/".concat(e,"/balance"),"text"),r={type:"native"},s=BigInt(n);return t?{address:e,tokenBalances:[{token:r,balance:s}]}:{address:e,token:r,balance:s}}getNonNativeTezosTokenBalancesQueryParams(e,t){if(!t)return new URLSearchParams({account:e});let n=w.isReadonlyArray(t)?1===t.length?t[0]:void 0:t;if(n)return new URLSearchParams({account:e,"token.contract":n.address,"token.tokenId":n.tokenId||"0"});let r=new Set,s=new Set;for(let e of t)r.add(e.address),s.add(e.tokenId||"0");let o=[...r].join(","),a=[...s].join(",");return new URLSearchParams({account:e,"token.contract.in":o,"token.tokenId.in":a})}splitTokensToNativeAndNonNativeTokens(e){let t;let n=[];for(let r of e)"native"===r.type?t=r:n.push(r);return{nativeToken:t,nonNativeTezosTokens:n}}};k(ez,"defaultLoadDataLimit",1e4);var ex=class extends T{constructor(e){super("Etherlink Node won't be able to receive a balance of the ".concat(L.toDisplayString(e),") token. Only native Etherlink token."))}},eL=class e extends T{static getMessage(e){return"RPC Error [Code: ".concat(e.code,"]. ").concat(e.message)}constructor(t){super(e.getMessage(t))}},eN=class extends et{async getBalance(e,t){if("native"!==t.type){let e=new ex(t);throw eA.logger.error(e),e}return this.getNativeEtherlinkTokenBalance(e,!1)}async getBalances(e,t,n){if(!("number"==typeof t||!t)&&t.length&&"native"!==t[0].type){let e=new ex(t[0]);throw eA.logger.error(e),e}return this.getNativeEtherlinkTokenBalance(e,!0)}async getNativeEtherlinkTokenBalance(e,t){eA.logger.log("Getting the Etherlink native token balance for the ".concat(e," address"));let n=await this.fetch("","json",{method:"POST",body:JSON.stringify({method:"eth_getBalance",params:[e,"latest"],id:1,jsonrpc:"2.0"})});this.ensureNoRPCErrors(n),eA.logger.log("The Etherlink native token balance for the  ".concat(e," address has been received"));let r={type:"native"},s=BigInt(n.result),o=t?{address:e,tokenBalances:[{token:r,balance:s}]}:{address:e,token:r,balance:s};return eA.logger.log("The Etherlink native token balance for the ".concat(e," address is ").concat(s)),o}ensureNoRPCErrors(e){if(!e.error)return;let t=new eL(e.error);throw eA.logger.error(ea(t)),t}},eE="\nbalance\nholder\ntoken\n",eI=class e{getTokenTransferQuery(e){return this.getTokenTransferQueryOrSubscription(e,!0)}getTokenTransferSubscriptions(e){return[this.getTokenTransferQueryOrSubscription(e,!1,!0),this.getTokenTransferQueryOrSubscription(e,!1,!1)]}getTokenTransfersQuery(e,t,n){let r="",s="";if(e){if("string"==typeof e||1===e.length){let t="string"==typeof e?e:e[0];r=this.getWhereArgumentForOneAddress(t,!0),s=this.getWhereArgumentForOneAddress(t,!1)}else e.length>1&&(r=this.getWhereArgumentForMultipleAddresses(e,!0),s=this.getWhereArgumentForMultipleAddresses(e,!1))}return r&&(r=", "+r),s&&(s=", "+s),"query TokenTransfers {\n      bridge_deposit(\n        order_by: { l1_transaction: { timestamp: desc } }\n        ".concat(r,"\n      ) {\n        ").concat(this.queryParts.bridgeDepositFields,"\n      }\n      bridge_withdrawal(\n        order_by: { l2_transaction: { timestamp: desc } }\n        ").concat(s,"\n      ) {\n        ").concat(this.queryParts.bridgeWithdrawalFields,"\n      }\n    }")}getTokenTransfersSubscriptions(e){let t=[];if(w.isReadonlyArray(e))for(let n of e)t.push(this.getAccountTokenTransfersSubscription(n,!0)),t.push(this.getAccountTokenTransfersSubscription(n,!1));else t.push(this.getAccountTokenTransfersSubscription(e,!0)),t.push(this.getAccountTokenTransfersSubscription(e,!1));return t}getAllTokenBalancesQuery(e,t,n){let r='where: {\n      holder: { _eq: "'.concat(this.prepareEtherlinkHexValue(e,!0),'" }\n    }');return"query TokenBalance {\n      l2_token_holder(".concat(r,", offset: ").concat(t,", limit: ").concat(n,") {\n        ").concat(eE,"\n      }\n    }")}getTokenBalancesQuery(e,t){let n='where: {\n      holder: { _eq: "'.concat(this.prepareEtherlinkHexValue(e,!0),'" },\n      token: { _in: ').concat(this.arrayToInOperatorValue(t.map(e=>this.prepareEtherlinkHexValue(e,!0)))," }\n    }");return"query TokenBalance {\n      l2_token_holder(".concat(n,") {\n        ").concat(eE,"\n      }\n    }")}getTokenBalanceQuery(e,t){let n='where: {\n      holder: { _eq: "'.concat(this.prepareEtherlinkHexValue(e,!0),'" },\n      token: { _eq: "').concat(this.prepareEtherlinkHexValue(t,!0),'" }\n    }');return"query TokenBalance {\n      l2_token_holder(".concat(n,") {\n        ").concat(eE,"\n      }\n    }")}getTokenTransferQueryOrSubscription(e,t,n){let r;return this.isEtherlinkTransaction(e)?(e=this.prepareEtherlinkHexValue(e,!1),r='where: {\n        l2_transaction: { transaction_hash: { _eq: "'.concat(e,'" } }\n      }')):r='where: {\n        l1_transaction: { operation_hash: { _eq: "'.concat(e,'" } }\n      }'),t?"query TokenTransfer {\n          bridge_deposit(".concat(r,") {\n            ").concat(this.queryParts.bridgeDepositFields,"\n          }\n          bridge_withdrawal(").concat(r,") {\n            ").concat(this.queryParts.bridgeWithdrawalFields,"\n          }\n        }"):n?"subscription TokenTransfer {\n            bridge_deposit(".concat(r,") {\n              ").concat(this.queryParts.bridgeDepositFields,"\n            }\n          }"):"subscription TokenTransfer {\n          bridge_withdrawal(".concat(r,") {\n            ").concat(this.queryParts.bridgeWithdrawalFields,"\n          }\n        }")}getAccountTokenTransfersSubscription(e,t){let n,r;let s=e?", ".concat(this.getWhereArgumentForOneAddress(e,t)):"";return t?(n="bridge_deposit",r=this.queryParts.bridgeDepositFields):(n="bridge_withdrawal",r=this.queryParts.bridgeWithdrawalFields),"subscription TokenTransfers {\n      ".concat(n,"(\n        order_by: { updated_at: desc },\n        limit: 1\n        ").concat(s,"\n      ) {\n        ").concat(r,"\n      }\n    }")}getWhereArgumentForOneAddress(e,t){return this.isEtherlinkAddress(e)?"where: {\n        ".concat(t?"l1_transaction":"l2_transaction",': { l2_account: { _eq: "').concat(this.prepareEtherlinkHexValue(e,!1),'" } }\n      }'):"where: {\n        ".concat(t?"l1_transaction":"l2_transaction",': { l1_account: { _eq: "').concat(e,'" } }\n      }')}getWhereArgumentForMultipleAddresses(e,t){let{tezosAddresses:n,etherlinkAddresses:r}=this.splitAddressesToTezosAndEtherlinkAddresses(e),s=n.length>0&&r.length>0,o="where: ";return s&&(o+=" { _or: ["),1===n.length?o+="{\n        ".concat(t?"l1_transaction":"l2_transaction",': { l1_account: { _eq: "').concat(n[0],'" } }\n      }'):n.length>1&&(o+="{\n        ".concat(t?"l1_transaction":"l2_transaction",": { l1_account: { _in: ").concat(this.arrayToInOperatorValue(n)," } }\n      }")),s&&(o+=","),1===r.length?o+="{\n        ".concat(t?"l1_transaction":"l2_transaction",': { l2_account: { \n          _eq: "').concat(this.prepareEtherlinkHexValue(r[0],!1),'"\n        } }\n      }'):r.length>1&&(o+="{\n        ".concat(t?"l1_transaction":"l2_transaction",": { l2_account: {\n          _in: ").concat(this.arrayToInOperatorValue(r.map(e=>this.prepareEtherlinkHexValue(e,!1))),"\n        } }\n      }")),s&&(o+=" ] }"),o}splitAddressesToTezosAndEtherlinkAddresses(e){let t=[],n=[];for(let r of e)this.isEtherlinkAddress(r)?n.push(r):t.push(r);return{tezosAddresses:t,etherlinkAddresses:n}}isEtherlinkTransaction(e){return 66===e.length&&e.startsWith("0x")}isEtherlinkAddress(e){return e.startsWith("0x")}prepareEtherlinkHexValue(e,t){return W.prepareHexPrefix(e,t).toLowerCase()}arrayToInOperatorValue(e){return e.reduce((t,n,r)=>{let s=t+'"'.concat(n,'"');return r<e.length-1&&(s+=","),s},"[")+"]"}constructor(t=e.defaultQueryParts){this.queryParts=t}};k(eI,"defaultQueryParts",{getBridgeOperationsFields:(e,t)=>"\ntype\nis_completed\nis_successful\n".concat(e?"deposit { ".concat(e," }"):"","\n").concat(t?"deposit { ".concat(t," }"):"","\n"),bridgeDepositFields:"\nl1_transaction {\n  level\n  operation_hash\n  amount\n  ticket {\n    token {\n      type\n      contract_address\n      token_id\n    }\n  }\n  l1_account\n  l2_account\n  timestamp\n  inbox_message {\n    type\n    level\n    index\n  }\n}\nl2_transaction {\n  level\n  transaction_hash\n  amount\n  l2_token {\n    id\n  }\n  timestamp\n}",bridgeWithdrawalFields:"\nl1_transaction {\n  level\n  operation_hash\n  timestamp\n}\nl2_transaction {\n  level\n  transaction_hash\n  amount\n  l2_token {\n    id\n    ticket {\n      token {\n        type\n        contract_address\n        token_id\n      }\n    }\n  }\n  l1_account\n  l2_account\n  timestamp\n  outbox_message {\n    level\n    index\n    commitment {\n      hash\n    }\n    proof\n  }\n}",l2TokenHolderFields:eE});var eO=class extends T{constructor(){super("AutoUpdate is disabled for the DipDupBridgeDataProvider")}},eW=class e extends T{static getMessage(e){return e.reduce((e,t,n)=>"".concat(e,"\n  ").concat(n+1,". ").concat(t.message,";"),"DipDup GraphQL Errors:")}constructor(t){super(e.getMessage(t))}},eR=class extends T{constructor(e){super("DipDup won't be able to receive a balance of the ".concat(L.toDisplayString(e),") token. Only ERC-20 tokens."))}},eF=e=>{switch(null==e?void 0:e.type.toLowerCase()){case"fa1.2":return{type:"fa1.2",address:e.contract_address};case"fa2":return{type:"fa2",address:e.contract_address,tokenId:e.token_id};default:return{type:"native"}}},eM=e=>e&&"xtz"!==e?{type:"erc20",address:W.toChecksumAddress(e)}:{type:"native"},eU=e=>{try{var t;let n=e.l1_transaction.l1_account,r=W.toChecksumAddress(e.l1_transaction.l2_account),s={blockId:e.l1_transaction.level,hash:e.l1_transaction.operation_hash,amount:BigInt(e.l1_transaction.amount),token:eF(e.l1_transaction.ticket.token),fee:0n,timestamp:e.l1_transaction.timestamp};return e.l2_transaction?{kind:0,status:300,source:n,receiver:r,tezosOperation:s,etherlinkOperation:{blockId:e.l2_transaction.level,hash:W.prepareHexPrefix(e.l2_transaction.transaction_hash,!0),amount:BigInt(e.l2_transaction.amount),token:eM(null===(t=e.l2_transaction.l2_token)||void 0===t?void 0:t.id),fee:0n,timestamp:e.l2_transaction.timestamp}}:{kind:0,status:100,source:n,receiver:r,tezosOperation:s}}catch(e){return eA.logger.error("Deposit DTO mapping error.",ea(e)),null}},eQ=e=>{try{var t,n,r,s;let o=W.toChecksumAddress(e.l2_transaction.l2_account),a=e.l2_transaction.l1_account,i=BigInt(e.l2_transaction.amount),c={blockId:e.l2_transaction.level,hash:W.prepareHexPrefix(e.l2_transaction.transaction_hash,!0),amount:i,token:eM(null===(t=e.l2_transaction.l2_token)||void 0===t?void 0:t.id),fee:0n,timestamp:e.l2_transaction.timestamp};return e.l1_transaction?{kind:1,status:300,source:o,receiver:a,tezosOperation:{blockId:e.l1_transaction.level,hash:e.l1_transaction.operation_hash,amount:i,token:eF(null===(r=e.l2_transaction.l2_token)||void 0===r?void 0:null===(n=r.ticket)||void 0===n?void 0:n.token),fee:0n,timestamp:e.l1_transaction.timestamp},etherlinkOperation:c,rollupData:{outboxMessageLevel:e.l2_transaction.outbox_message.level,outboxMessageIndex:e.l2_transaction.outbox_message.index,commitment:(null===(s=e.l2_transaction.outbox_message.commitment)||void 0===s?void 0:s.hash)||"",proof:e.l2_transaction.outbox_message.proof||""}}:e.l2_transaction.outbox_message.commitment&&e.l2_transaction.outbox_message.proof?{kind:1,status:200,source:o,receiver:a,etherlinkOperation:c,rollupData:{outboxMessageLevel:e.l2_transaction.outbox_message.level,outboxMessageIndex:e.l2_transaction.outbox_message.index,commitment:e.l2_transaction.outbox_message.commitment.hash,proof:e.l2_transaction.outbox_message.proof}}:{kind:1,status:100,source:o,receiver:a,etherlinkOperation:c,rollupData:{outboxMessageLevel:e.l2_transaction.outbox_message.level,outboxMessageIndex:e.l2_transaction.outbox_message.index}}}catch(e){return eA.logger.error("Withdrawal DTO mapping error.",ea(e)),null}},eH=e=>{try{let t=e.l2_token_holder[0];return t?{address:W.toChecksumAddress(t.holder),balance:BigInt(t.balance),token:eM(t.token)}:null}catch(e){return eA.logger.error("Token Balances DTO mapping error.",ea(e)),null}},eq=(e,t)=>{try{var n;let r=null===(n=e.l2_token_holder[0])||void 0===n?void 0:n.holder;return{address:(r?W.toChecksumAddress(r):t)||"",tokenBalances:e.l2_token_holder.map(e=>({balance:BigInt(e.balance),token:eM(e.token)}))}}catch(e){return eA.logger.error("Token Balances DTO mapping error.",ea(e)),{address:t||"",tokenBalances:[]}}},ej=class e{get readyState(){return this.socket.readyState}get socket(){if(!this._socket)throw Error("Internal websocket is not created. Use the connect method first");return this._socket}async connect(){return this.disconnect(),new Promise((t,n)=>{this._socket=new WebSocket(this.url,e.webSocketProtocol);let r=()=>{this.socket.removeEventListener("open",r),t()},s=e=>{this.socket.removeEventListener("error",s),n(e)};this.socket.addEventListener("open",r),this.socket.addEventListener("error",s),this.socket.addEventListener("message",this.onMessageReceived),this.socket.addEventListener("error",this.onError),this.socket.addEventListener("close",this.onClosed)})}disconnect(){this._socket&&(this.socket.removeEventListener("message",this.onMessageReceived),this.socket.removeEventListener("error",this.onError),this.socket.removeEventListener("close",this.onClosed),this.socket.close())}send(e){this.socket.send(JSON.stringify(e))}constructor(e){this.url=e,k(this,"events",{messageReceived:new en,closed:new en}),k(this,"_socket"),k(this,"onMessageReceived",e=>{try{let t=JSON.parse(e.data);this.events.messageReceived.emit(t)}catch(e){console.error(e)}}),k(this,"onError",e=>{throw Error("Websocket received error: ".concat(JSON.stringify(e)))}),k(this,"onClosed",e=>{this.events.closed.emit(this,e)})}};k(ej,"webSocketProtocol","graphql-ws");var eG=class{get isStarted(){return this._isStarted}get isSocketOpen(){return 1===this.socket.readyState}async start(){if(!this.isStarted&&!this._isStarting){this._isStarting=!0;try{this.socket.events.messageReceived.addListener(this.onSocketMessageReceived),this.socket.events.closed.addListener(this.onSocketClosed),await this.connect(),this._isStarted=!0}catch(e){throw this._isStarting=!1,this._isStarted=!1,Error("Socket error",{cause:e})}}}stop(){this.isStarted&&(this.socket.events.messageReceived.removeListener(this.onSocketMessageReceived),this.socket.events.closed.removeListener(this.onSocketClosed),this.disconnect(),this.reconnectScheduler[Symbol.dispose](),this._isStarted=!1)}subscribe(e){let t=this.subscriptions.get(e);return t?(t.subscribersCount++,!1):(t={id:this.subscriptionIdCounter++,query:e,subscribersCount:1},this.subscribeToSubscription(t),this.subscriptions.set(t.query,t),!0)}unsubscribe(e){let t=this.subscriptions.get(e);return!(!t||--t.subscribersCount>0)&&(this.unsubscribeFromSubscription(t.id),this.subscriptions.delete(t.query),!0)}unsubscribeFromAllSubscriptions(){if(!this.subscriptions.size)return!1;for(let e of this.subscriptions.values())this.unsubscribeFromSubscription(e.id);return this.subscriptions.clear(),!0}async connect(){await this.socket.connect(),this.socket.send({type:"connection_init",payload:{headers:{"content-type":"application/json"},lazy:!0}}),this.subscribeToAllSubscriptions()}subscribeToAllSubscriptions(){if(this.isSocketOpen)for(let e of this.subscriptions.values())this.subscribeToSubscription(e)}subscribeToSubscription(e){if(!this.isSocketOpen)return;let t={type:"start",id:e.id.toString(),payload:{query:e.query}};this.socket.send(t)}unsubscribeFromSubscription(e){if(!this.isSocketOpen)return;let t={type:"stop",id:e.toString()};this.socket.send(t)}disconnect(){this.socket.disconnect(),this.subscriptions.clear()}constructor(e){this.webSocketApiBaseUrl=e,k(this,"events",{messageReceived:new en}),k(this,"socket"),k(this,"subscriptions",new Map),k(this,"subscriptionIdCounter",0),k(this,"reconnectScheduler",new er([1e3,5e3,3e4,6e4],12e4)),k(this,"_isStarted",!1),k(this,"_isStarting",!1),k(this,"onSocketClosed",(e,t)=>{eA.logger.warn("DipDup socket is closed. Reason:",t.reason),this.reconnectScheduler.setTimeout(()=>{eA.logger.log("DipDup socket reconnection..."),this.connect()})}),k(this,"onSocketMessageReceived",e=>{switch(e.type){case"ka":case"connection_ack":break;default:this.events.messageReceived.emit(e)}}),this.socket=new ej(new URL(_.trimSlashes(this.webSocketApiBaseUrl)+"/v1/graphql"))}},eV=class e extends et{get dipDupWebSocketClient(){if(this._dipDupWebSocketClient)return this._dipDupWebSocketClient;let e=new eO;throw eA.logger.error(ea(e)),e}async getTokenTransfer(e){var t,n,r,s;let o="string"==typeof e?e:0===e.kind?e.tezosOperation.hash:e.etherlinkOperation.hash;eA.logger.log("Getting token transfer by the operation hash:",o);let a=await this.fetch("/v1/graphql","json",{method:"POST",body:JSON.stringify({query:this.dipDupGraphQLQueryBuilder.getTokenTransferQuery(o)})});this.ensureNoDipDupGraphQLErrors(a),eA.logger.log("Token transfer has been received by the operation hash:",o),eA.logger.debug("Mapping the first of bridge_deposit or bridge_withdrawal DTOs to BridgeTokenTransfer...");let i=a.data.bridge_deposit[0]&&eU(a.data.bridge_deposit[0])||a.data.bridge_withdrawal[0]&&eQ(a.data.bridge_withdrawal[0]);return eA.logger.debug("Mapping has been completed."),null===(t=(n=eA.lazyLogger).log)||void 0===t||t.call(n,el(i)),null===(r=(s=eA.lazyLogger).debug)||void 0===r||r.call(s,ed(i)),i||null}async getTokenTransfers(e,t){return this.getTokenTransfersInternal(void 0,e,t)}async getAccountTokenTransfers(e,t,n){return this.getTokenTransfersInternal(e,t,n)}subscribeToTokenTransfer(e){this.startDipDupWebSocketClientIfNeeded();let t="string"==typeof e?e:H.getInitialOperationHash(e);eA.logger.log("Subscribe to the token transfer by the initial operation:",t);let n=this.dipDupGraphQLQueryBuilder.getTokenTransferSubscriptions(t);this.dipDupWebSocketClient.subscribe(n[0]),this.dipDupWebSocketClient.subscribe(n[1])}unsubscribeFromTokenTransfer(e){let t="string"==typeof e?e:H.getInitialOperationHash(e);eA.logger.log("Unsubscribe from the token transfer by the initial operation:",t);let n=this.dipDupGraphQLQueryBuilder.getTokenTransferSubscriptions(t);this.dipDupWebSocketClient.unsubscribe(n[1]),this.dipDupWebSocketClient.unsubscribe(n[0])}subscribeToTokenTransfers(){this.startDipDupWebSocketClientIfNeeded(),this.subscribeToTokenTransfersInternal(null)}unsubscribeFromTokenTransfers(){this.unsubscribeFromTokenTransfersInternal(null)}subscribeToAccountTokenTransfers(e){this.startDipDupWebSocketClientIfNeeded(),this.subscribeToTokenTransfersInternal(e)}unsubscribeFromAccountTokenTransfers(e){this.unsubscribeFromTokenTransfersInternal(e)}unsubscribeFromAllSubscriptions(){this.dipDupWebSocketClient.unsubscribeFromAllSubscriptions()}async getBalance(e,t){var n,r,s,o,a,i;if("erc20"!==t.type){let e=new eR(t);throw eA.logger.error(e),e}null===(n=(r=eA.lazyLogger).log)||void 0===n||n.call(r,"Getting balance of the ".concat(ei(t)," token for the ").concat(e," address"));let c=await this.fetch("/v1/graphql","json",{method:"POST",body:JSON.stringify({query:this.dipDupGraphQLQueryBuilder.getTokenBalanceQuery(e,t.address)})});this.ensureNoDipDupGraphQLErrors(c),null===(s=(o=eA.lazyLogger).log)||void 0===s||s.call(o,"The balance of the ".concat(ei(t)," token for the ").concat(e," address has been received")),eA.logger.debug("Mapping the tokenBalancesDTO to AccountTokenBalances...");let l=eH(c.data);return eA.logger.debug("Mapping has been completed."),null===(a=(i=eA.lazyLogger).log)||void 0===a||a.call(i,"The balance of the ".concat(ei(t)," token for the ").concat(e," address is ").concat(null==l?void 0:l.balance)),l||{address:e,token:t,balance:0n}}async getBalances(e,t,n){var r,s,o,a;let i;let c="number"==typeof t||!t;if(c)i=this.dipDupGraphQLQueryBuilder.getAllTokenBalancesQuery(e,this.getPreparedOffsetParameter(t),this.getPreparedLimitParameter(n));else{let n=t.map(e=>e.address);i=this.dipDupGraphQLQueryBuilder.getTokenBalancesQuery(e,n)}null===(r=(s=eA.lazyLogger).log)||void 0===r||r.call(s,"Getting balances of the ".concat(c?"all":ei(t)," tokens for the ").concat(e," address"));let l=await this.fetch("/v1/graphql","json",{method:"POST",body:JSON.stringify({query:i})});this.ensureNoDipDupGraphQLErrors(l),null===(o=(a=eA.lazyLogger).log)||void 0===o||o.call(a,"The balances of the ".concat(c?"all":ei(t)," tokens for the ").concat(e," address has been received")),eA.logger.debug("Mapping the tokenBalancesDTO to AccountTokenBalances...");let d=eq(l.data,e);return eA.logger.debug("Mapping has been completed."),d}[Symbol.dispose](){var e;null===(e=this._dipDupWebSocketClient)||void 0===e||e.events.messageReceived.removeListener(this.onSocketMessageReceived),this.stopDipDupWebSocketClient()}startDipDupWebSocketClientIfNeeded(){this._dipDupWebSocketClient&&this._dipDupWebSocketClient.start().catch(e=>eA.logger.error("DipDup Web Socket has not bee started. Error = ".concat(ea(e))))}stopDipDupWebSocketClient(){var e;null===(e=this._dipDupWebSocketClient)||void 0===e||e.stop()}async getTokenTransfersInternal(e,t,n){var r,s,o,a;t=this.getPreparedOffsetParameter(t),n=this.getPreparedLimitParameter(n),null===(r=(s=eA.lazyLogger).log)||void 0===r||r.call(s,e?"Getting token transfers for ".concat("string"==typeof e?"".concat(e," address."):"[".concat(e.join(", "),"] addresses.")):"Getting all token transfers.","Offset == ".concat(t,"; Limit == ").concat(n));let i=await this.fetch("/v1/graphql","json",{method:"POST",body:JSON.stringify({query:this.dipDupGraphQLQueryBuilder.getTokenTransfersQuery(e,t,n)})});this.ensureNoDipDupGraphQLErrors(i),null===(o=(a=eA.lazyLogger).log)||void 0===o||o.call(a,e?"Token transfers have been received for ".concat("string"==typeof e?"".concat(e," address."):"[".concat(e.join(", "),"] addresses.")):"Token transfers have been received.","Offset == ".concat(t,"; Limit == ").concat(n,"."),"Deposits Count == ".concat(i.data.bridge_deposit.length,"; Withdrawal Count == ").concat(i.data.bridge_withdrawal.length)),eA.logger.debug("Mapping bridge_deposit and bridge_withdrawal DTOs to BridgeTokenTransfers...");let c=[];for(let e of i.data.bridge_deposit){let t=eU(e);t&&c.push(t)}for(let e of i.data.bridge_withdrawal){let t=eQ(e);t&&c.push(t)}return c.sort((e,t)=>{let n=H.getInitialOperation(e);return H.getInitialOperation(t).timestamp.localeCompare(n.timestamp)}),c.slice(t,t+n),eA.logger.debug("Mapping has been completed.","BridgeTokenTransfers Count = ".concat(c.length)),c}subscribeToTokenTransfersInternal(e){var t,n;null===(t=(n=eA.lazyLogger).log)||void 0===t||t.call(n,e?"Subscribe to token transfers of the ".concat("string"==typeof e?"".concat(e," address."):"[".concat(e.join(", "),"] addresses.")):"Subscribe to all token transfers.");let r=this.dipDupGraphQLQueryBuilder.getTokenTransfersSubscriptions(e);for(let e of(eA.logger.debug("Requested subscriptions count",r.length),r))this.dipDupWebSocketClient.subscribe(e),this.dipDupWebSocketClient.subscribe(e)}unsubscribeFromTokenTransfersInternal(e){var t,n;null===(t=(n=eA.lazyLogger).log)||void 0===t||t.call(n,e?"Unsubscribe from token transfers of the ".concat("string"==typeof e?"".concat(e," address."):"[".concat(e.join(", "),"] addresses.")):"Unsubscribe from all token transfers.");let r=this.dipDupGraphQLQueryBuilder.getTokenTransfersSubscriptions(e);for(let e of(eA.logger.debug("Requested subscriptions count",r.length),r))this.dipDupWebSocketClient.unsubscribe(e),this.dipDupWebSocketClient.unsubscribe(e)}createDipDupGraphQLQueryBuilder(){return new eI}ensureNoDipDupGraphQLErrors(e){if(!e.errors||!e.errors.length)return;let t=new eW(e.errors);throw eA.logger.error(ea(t)),t}getPreparedOffsetParameter(e){return e&&e>0?e:0}getPreparedLimitParameter(t){return t&&t>0?t:e.defaultLoadDataLimit}constructor(e){super(e.baseUrl),k(this,"events",{tokenTransferCreated:new en,tokenTransferUpdated:new en}),k(this,"dipDupGraphQLQueryBuilder"),k(this,"_dipDupWebSocketClient"),k(this,"onSocketMessageReceived",e=>{try{var t,n,r,s,o,a;if("data"!==e.type||!e.payload.data)return;eA.logger.debug("DipDup data message was received.","Message Id == ".concat(e.id));let i=e.payload.data,c=null==i?void 0:null===(t=i.bridge_deposit)||void 0===t?void 0:t[0],l=null==i?void 0:null===(n=i.bridge_withdrawal)||void 0===n?void 0:n[0];if(c||l){let e=c?eU(i.bridge_deposit[0]):eQ(i.bridge_withdrawal[0]);eA.logger.log("".concat(c?"Deposit":"Withdrawal"," updated was received")),null===(r=(s=eA.lazyLogger).log)||void 0===r||r.call(s,el(e)),null===(o=(a=eA.lazyLogger).debug)||void 0===o||o.call(a,ed(e)),e&&this.events.tokenTransferUpdated.emit(e)}}catch(e){eA.logger.error("Unknown error in the socket message handler.",ea(e))}}),this.dipDupGraphQLQueryBuilder=this.createDipDupGraphQLQueryBuilder(),e.autoUpdate&&"websocket"===e.autoUpdate.type?(this._dipDupWebSocketClient=new eG(e.autoUpdate.webSocketApiBaseUrl),this._dipDupWebSocketClient.events.messageReceived.addListener(this.onSocketMessageReceived),e.autoUpdate.startImmediately&&this.startDipDupWebSocketClientIfNeeded()):this._dipDupWebSocketClient=null}};k(eV,"defaultLoadDataLimit",100);var eZ=[{type:"native"}],eK=class{get events(){return this.dipDupBridgeDataProvider.events}async getTokenTransfer(e){return this.dipDupBridgeDataProvider.getTokenTransfer(e)}async getTokenTransfers(e,t){return this.dipDupBridgeDataProvider.getTokenTransfers(e,t)}async getAccountTokenTransfers(e,t,n){return this.dipDupBridgeDataProvider.getAccountTokenTransfers(e,t,n)}subscribeToTokenTransfer(e){return this.dipDupBridgeDataProvider.subscribeToTokenTransfer(e)}unsubscribeFromTokenTransfer(e){return this.dipDupBridgeDataProvider.unsubscribeFromTokenTransfer(e)}subscribeToTokenTransfers(){return this.dipDupBridgeDataProvider.subscribeToTokenTransfers()}unsubscribeFromTokenTransfers(){return this.dipDupBridgeDataProvider.unsubscribeFromTokenTransfers()}subscribeToAccountTokenTransfers(e){return this.dipDupBridgeDataProvider.subscribeToAccountTokenTransfers(e)}unsubscribeFromAccountTokenTransfers(e){return this.dipDupBridgeDataProvider.unsubscribeFromAccountTokenTransfers(e)}unsubscribeFromAllSubscriptions(){return this.dipDupBridgeDataProvider.unsubscribeFromAllSubscriptions()}async getBalances(e,t,n){let r=this.isEtherlinkAccount(e),s="number"!=typeof t&&t?this.groupTokens(t):null,o=[];if(r?s?(s.nativeTokens.length&&o.push(this.etherlinkNodeBalancesDataProvider.getBalances(e,s.nativeTokens)),s.nonNativeEtherlinkTokens.length&&o.push(this.dipDupBridgeDataProvider.getBalances(e,s.nonNativeEtherlinkTokens))):(t||o.push(this.etherlinkNodeBalancesDataProvider.getBalances(e,eZ)),o.push(this.dipDupBridgeDataProvider.getBalances(e,t,n))):s?(s.nativeTokens.length&&o.push(this.tzKTBalancesDataProvider.getBalances(e,s.nativeTokens)),s.nonNativeTezosTokens.length&&o.push(this.tzKTBalancesDataProvider.getBalances(e,s.nonNativeTezosTokens))):o.push(this.tzKTBalancesDataProvider.getBalances(e,t,n)),!o.length)return{address:e,tokenBalances:[]};let a=await Promise.allSettled(o),i=[];for(let e of a)"fulfilled"===e.status&&i.push(e.value);return this.mergeAccountTokenBalances(i)}getBalance(e,t){return this.isEtherlinkAccount(e)?"native"===t.type?this.etherlinkNodeBalancesDataProvider.getBalance(e,t):this.dipDupBridgeDataProvider.getBalance(e,t):this.tzKTBalancesDataProvider.getBalance(e,t)}getRegisteredTokenPair(e){return this.bridgeDataProvider.getRegisteredTokenPair(e)}getRegisteredTokenPairs(e,t){return this.bridgeDataProvider.getRegisteredTokenPairs(e,t)}[Symbol.dispose](){this.dipDupBridgeDataProvider[Symbol.dispose]()}mergeAccountTokenBalances(e){if(!e.length)throw Error("It's not possible to merge an empty array for the AccountTokenBalances");return{address:e[0].address,tokenBalances:e.flatMap(e=>e.tokenBalances)}}isEtherlinkAccount(e){return e.startsWith("0x")}constructor(e){k(this,"bridgeDataProvider"),k(this,"dipDupBridgeDataProvider"),k(this,"tzKTBalancesDataProvider"),k(this,"etherlinkNodeBalancesDataProvider"),k(this,"groupTokens",y(e=>{let t={nativeTokens:[],nonNativeEtherlinkTokens:[],nonNativeTezosTokens:[]};for(let n of e)"native"===n.type?t.nativeTokens.push(n):"erc20"===n.type?t.nonNativeEtherlinkTokens.push(n):t.nonNativeTezosTokens.push(n);return t})),this.bridgeDataProvider=w.isReadonlyArray(e.tokenPairs)?new es(e.tokenPairs):e.tokenPairs,this.dipDupBridgeDataProvider=new eV({baseUrl:e.dipDup.baseUrl,autoUpdate:{type:"websocket",webSocketApiBaseUrl:e.dipDup.webSocketApiBaseUrl,startImmediately:!1}}),this.tzKTBalancesDataProvider=new ez(e.tzKTApiBaseUrl),this.etherlinkNodeBalancesDataProvider=new eN(e.etherlinkRpcUrl)}},eJ=class e extends T{static getMessage(e){return"Token pair not found for the ".concat(L.toDisplayString(e)," token")}constructor(t){super(e.getMessage(t))}},e$=class e extends T{static getMessage(e,t,n,r){return"".concat(t," has an insufficient balance ").concat(L.toDisplayString(e),". Balance = ").concat(n,". Requested = ").concat(r)}constructor(t,n,r,s){super(e.getMessage(t,n,r,s))}},eX=[{anonymous:!1,inputs:[{indexed:!0,internalType:"uint256",name:"ticketHash",type:"uint256"},{indexed:!1,internalType:"address",name:"ticketOwner",type:"address"},{indexed:!1,internalType:"address",name:"receiver",type:"address"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"},{indexed:!1,internalType:"uint256",name:"inboxLevel",type:"uint256"},{indexed:!1,internalType:"uint256",name:"inboxMsgId",type:"uint256"}],name:"Deposit",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"uint256",name:"ticketHash",type:"uint256"},{indexed:!1,internalType:"address",name:"sender",type:"address"},{indexed:!1,internalType:"address",name:"tiketOwner",type:"address"},{indexed:!1,internalType:"bytes",name:"receiver",type:"bytes"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"},{indexed:!1,internalType:"uint256",name:"outboxLevel",type:"uint256"},{indexed:!1,internalType:"uint256",name:"outboxMsgId",type:"uint256"}],name:"Withdraw",type:"event"},{inputs:[{internalType:"bytes22",name:"ticketer",type:"bytes22"},{internalType:"bytes",name:"content",type:"bytes"},{internalType:"address",name:"owner",type:"address"}],name:"getBalance",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"ticketReceiver",type:"address"},{internalType:"address",name:"receiver",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"},{internalType:"bytes22",name:"ticketer",type:"bytes22"},{internalType:"bytes",name:"identifier",type:"bytes"}],name:"inboxDeposit",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"ticketOwner",type:"address"},{internalType:"bytes",name:"receiver",type:"bytes"},{internalType:"uint256",name:"amount",type:"uint256"},{internalType:"bytes22",name:"ticketer",type:"bytes22"},{internalType:"bytes",name:"content",type:"bytes"}],name:"withdraw",outputs:[],stateMutability:"nonpayable",type:"function"}],eY=class{async withdraw(e){let t=S.convertAddressToBytes(e.tezosReceiverAddress,!0),n=S.convertAddressToBytes(e.tezosTicketerAddress,!0),r=S.convertAddressToBytes(e.tezosProxyAddress),s=this.kernelContract.methods.withdraw(e.etherlinkTokenProxyContractAddress,t+r,e.amount,n,e.tezosTicketerContent).encodeABI(),o=await this.etherlinkToolkit.eth.getGasPrice();return await this.etherlinkToolkit.eth.sendTransaction({from:e.etherlinkSenderAddress,to:this.withdrawPrecompileAddress,gas:BigInt("30000"),gasPrice:o,data:s})}constructor(e){k(this,"etherlinkToolkit"),k(this,"kernelContract"),k(this,"withdrawPrecompileAddress"),this.etherlinkToolkit=e.etherlinkToolkit,this.withdrawPrecompileAddress=e.withdrawPrecompileAddress,this.kernelContract=new this.etherlinkToolkit.eth.Contract(eX,this.withdrawPrecompileAddress)}},e0={};function e1(e){let t=e.batch;return(void 0===e.isNeedToReset||e.isNeedToReset)&&t.withContractCall(e.tokenContract.methods.approve(e.approvedAddress,0n)),t.withContractCall(e.tokenContract.methods.approve(e.approvedAddress,e.approvedAmount)),Array.isArray(e.contractCalls)?e.contractCalls.forEach(e=>t.withContractCall(e)):t.withContractCall(e.contractCalls),t}g(e0,{wrapContractCallsWithApprove:()=>e1});var e2={};function e3(e){let t=e.batch.withContractCall(e.tokenContract.methods.update_operators([{add_operator:{owner:e.ownerAddress,operator:e.approvedAddress,token_id:e.tokenId}}]));return Array.isArray(e.contractCalls)?e.contractCalls.forEach(e=>t.withContractCall(e)):t.withContractCall(e.contractCalls),t.withContractCall(e.tokenContract.methods.update_operators([{remove_operator:{owner:e.ownerAddress,operator:e.approvedAddress,token_id:e.tokenId}}])),t}g(e2,{wrapContractCallsWithApprove:()=>e3});var e4=class{async depositNativeToken(e){let t=await this.createDepositNativeTokenOperation(e.etherlinkReceiverAddress,e.ticketHelperContractAddress);return this.createBatch().withContractCall(t,{amount:Number(e.amount),mutez:!0}).send()}async depositNonNativeToken(e){let t=await this.createDepositNonNativeTokenOperation(e.etherlinkReceiverAddress,e.amount,e.ticketHelperContractAddress),n=this.createBatch();return(n=await ("fa2"===e.token.type?this.wrapContractCallsWithFA2TokenApprove(n,t,e.token,e.ticketHelperContractAddress):this.wrapContractCallsWithFA12TokenApprove(n,t,e.token,e.amount,e.ticketHelperContractAddress))).send()}async finishWithdraw(e,t){return this.tezosToolkit.contract.smartRollupExecuteOutboxMessage({rollup:this.rollupAddress,cementedCommitment:e,outputProof:t})}async createDepositNativeTokenOperation(e,t){let n=await this.getNativeTokenTicketHelperContract(t),r=this.packDepositRoutingInfo(e);return n.methodsObject.deposit({evm_address:this.rollupAddress,l2_address:r})}async createDepositNonNativeTokenOperation(e,t,n){let r=await this.getNonNativeTokenTicketHelperContract(n),s=this.packDepositRoutingInfo(e);return r.methodsObject.deposit({rollup:this.rollupAddress,receiver:s,amount:t})}packDepositRoutingInfo(e,t){return t?"".concat(e.substring(2)).concat(t.substring(2)):e.substring(2)}async wrapContractCallsWithFA12TokenApprove(e,t,n,r,s){let o=await this.getFA12TokenContract(n.address);return e0.wrapContractCallsWithApprove({batch:e,approvedAddress:s,approvedAmount:r,tokenContract:o,contractCalls:t})}async wrapContractCallsWithFA2TokenApprove(e,t,n,r){let[s,o]=await Promise.all([this.getFA2TokenContract(n.address),this.tezosToolkit.wallet.pkh()]);return e2.wrapContractCallsWithApprove({batch:e,approvedAddress:r,ownerAddress:o,tokenId:n.tokenId,tokenContract:s,contractCalls:t})}constructor(e){k(this,"tezosToolkit"),k(this,"rollupAddress"),k(this,"localForger",new u.P$),this.tezosToolkit=e.tezosToolkit,this.rollupAddress=e.rollupAddress}},e6=class extends e4{createBatch(e){return this.tezosToolkit.contract.batch(e)}getNativeTokenTicketHelperContract(e){return this.tezosToolkit.contract.at(e)}getNonNativeTokenTicketHelperContract(e){return this.tezosToolkit.contract.at(e)}getFA12TokenContract(e){return this.tezosToolkit.contract.at(e)}getFA2TokenContract(e){return this.tezosToolkit.contract.at(e)}constructor(e){super(e),k(this,"wallet"),this.wallet=new e5(e)}},e5=class extends e4{createBatch(e){return this.tezosToolkit.wallet.batch(e)}getNativeTokenTicketHelperContract(e){return this.tezosToolkit.wallet.at(e)}getNonNativeTokenTicketHelperContract(e){return this.tezosToolkit.wallet.at(e)}getFA12TokenContract(e){return this.tezosToolkit.wallet.at(e)}getFA2TokenContract(e){return this.tezosToolkit.wallet.at(e)}},e8={prim:"pair",annots:["%content"],args:[{prim:"nat"},{prim:"option",args:[{prim:"bytes"}]}]},e9=class{get isDisposed(){return this._isDisposed}addEventListener(e,t){this.ensureIsNotDisposed(),this.events[e].addListener(t)}removeEventListener(e,t){this.ensureIsNotDisposed(),this.events[e].removeListener(t)}removeAllEventListeners(e){this.ensureIsNotDisposed(),this.events[e].removeAllListeners()}async waitForStatus(e,t){if(this.ensureIsNotDisposed(),e.status>=t)return e;let n=H.getInitialOperationHash(e),r=await this.bridgeComponents.transfersBridgeDataProvider.getTokenTransfer(n);if((null==r?void 0:r.status)===t)return r;let s=this.tokenTransferOperationWatchers.get(n);s||(s=new Map,this.tokenTransferOperationWatchers.set(n,s));let o=s.get(t);if(o)return o.promise;let a=new Promise((e,r)=>{let s=this.tokenTransferOperationWatchers.get(n);if(!s){r("Status watchers map not found for the ".concat(n," operation"));return}setTimeout(()=>{try{this.bridgeComponents.transfersBridgeDataProvider.subscribeToTokenTransfer(n),s.set(t,{promise:a,resolve:t=>{this.bridgeComponents.transfersBridgeDataProvider.unsubscribeFromTokenTransfer(n),e(t)},reject:e=>{this.bridgeComponents.transfersBridgeDataProvider.unsubscribeFromTokenTransfer(n),r(e)}})}catch(e){eA.logger.error(ea(e)),r(e)}},0)});return a}async deposit(e,t,n,r){var s,o,a,i,c,l;this.ensureIsNotDisposed();let d=await this.getTezosConnectedAddress(),u="string"==typeof n?n:await this.getEtherlinkConnectedAddress(),h="string"!=typeof n&&n?n:r,p=!h||void 0===h.useWalletApi||h.useWalletApi;null===(s=(o=eA.lazyLogger).log)||void 0===s||s.call(o,"Depositing ".concat(e.toString(10)," ").concat(ei(t)," from ").concat(d," to ").concat(u)),eA.logger.debug("Use the Taquito ".concat(p?"Wallet":"Contract"," API"));let g=await this.bridgeComponents.tokensBridgeDataProvider.getRegisteredTokenPair(t);if(!g){let e=new eJ(t);throw eA.logger.error(ea(e)),e}let k=await this.bridgeComponents.balancesBridgeDataProvider.getBalance(d,t);if(e>k.balance){let n=new e$(t,d,k.balance,e);throw eA.logger.error(ea(n)),n}eA.logger.log("The ".concat(d," has enough tokens to deposit ").concat(e));let T=g.tezos.ticketHelperContractAddress,b=await (p?this.depositUsingWalletApi(t,e,u,h,T):this.depositUsingContractApi(t,e,u,h,T));return null===(a=(i=eA.lazyLogger).log)||void 0===a||a.call(i,el(b.tokenTransfer)),null===(c=(l=eA.lazyLogger).debug)||void 0===c||c.call(l,ed(b.tokenTransfer)),this.emitLocalTokenTransferCreated(b.tokenTransfer),b}async startWithdraw(e,t,n){this.ensureIsNotDisposed();let r=await this.getEtherlinkConnectedAddress();n||(n=await this.getTezosConnectedAddress());let s=await this.bridgeComponents.tokensBridgeDataProvider.getRegisteredTokenPair(t);if(!s){let e=new eJ(t);throw eA.logger.error(ea(e)),e}if("native"===s.etherlink.type||"native"===s.tezos.type)throw Error("Withdrawal of native tokens is not supported yet");let o=await this.bridgeComponents.balancesBridgeDataProvider.getBalance(r,t);if(e>o.balance){let n=new e$(t,r,o.balance,e);throw eA.logger.error(ea(n)),n}eA.logger.log("The ".concat(r," has enough tokens to withdraw ").concat(e));let a=s.tezos.ticketerContractAddress,i=s.etherlink.address,[c,l]=await Promise.all([this.getEtherlinkConnectedAddress(),this.getTezosTicketerContent(a)]),d=await this.bridgeComponents.etherlink.withdraw({tezosReceiverAddress:n,amount:e,tezosTicketerContent:l,etherlinkSenderAddress:c,etherlinkTokenProxyContractAddress:i,tezosProxyAddress:a,tezosTicketerAddress:a}),u={kind:1,status:0,source:W.toChecksumAddress(d.from),receiver:n,etherlinkOperation:{hash:d.transactionHash.toString(),timestamp:Date.now().toString(),amount:e,token:t}};return this.emitLocalTokenTransferCreated(u),{tokenTransfer:u,startWithdrawOperation:d}}async finishWithdraw(e){this.ensureIsNotDisposed();let t=await this.bridgeComponents.tezos.finishWithdraw(e.rollupData.commitment,e.rollupData.proof);return{tokenTransfer:e,finishWithdrawOperation:t}}async getTezosConnectedAddress(){return this.ensureIsNotDisposed(),this.tezosToolkit.wallet.pkh()}async getEtherlinkConnectedAddress(){this.ensureIsNotDisposed();let e=(await this.etherlinkToolkit.eth.getAccounts())[0]||this.etherlinkToolkit.eth.defaultAccount;if(!e)throw Error("Address is unavailable");return e}[Symbol.dispose](){this._isDisposed||(w.isDisposable(this.bridgeComponents.tokensBridgeDataProvider)&&this.bridgeComponents.tokensBridgeDataProvider[Symbol.dispose](),w.isDisposable(this.bridgeComponents.balancesBridgeDataProvider)&&this.bridgeComponents.balancesBridgeDataProvider[Symbol.dispose](),w.isDisposable(this.bridgeComponents.transfersBridgeDataProvider)&&this.bridgeComponents.transfersBridgeDataProvider[Symbol.dispose](),this.rejectAndClearAllStatusWatchers("The TokenBridge has been stopped!"),this.detachEvents(),this._isDisposed=!0)}getBalance(e,t){return this.bridgeComponents.balancesBridgeDataProvider.getBalance(e,t)}getBalances(e,t,n){return this.bridgeComponents.balancesBridgeDataProvider.getBalances(e,t,n)}getRegisteredTokenPair(e){return this.bridgeComponents.tokensBridgeDataProvider.getRegisteredTokenPair(e)}getRegisteredTokenPairs(e,t){return this.bridgeComponents.tokensBridgeDataProvider.getRegisteredTokenPairs(e,t)}getTokenTransfer(e){return this.bridgeComponents.transfersBridgeDataProvider.getTokenTransfer(e)}getTokenTransfers(e,t){return this.bridgeComponents.transfersBridgeDataProvider.getTokenTransfers(e,t)}getAccountTokenTransfers(e,t,n){return this.bridgeComponents.transfersBridgeDataProvider.getAccountTokenTransfers(e,t,n)}subscribeToTokenTransfer(e){this.bridgeComponents.transfersBridgeDataProvider.subscribeToTokenTransfer(e)}unsubscribeFromTokenTransfer(e){this.bridgeComponents.transfersBridgeDataProvider.unsubscribeFromTokenTransfer(e)}subscribeToTokenTransfers(){this.bridgeComponents.transfersBridgeDataProvider.subscribeToTokenTransfers()}unsubscribeFromTokenTransfers(){this.bridgeComponents.transfersBridgeDataProvider.unsubscribeFromTokenTransfers()}subscribeToAccountTokenTransfers(e){this.bridgeComponents.transfersBridgeDataProvider.subscribeToAccountTokenTransfers(e)}unsubscribeFromAccountTokenTransfers(e){this.bridgeComponents.transfersBridgeDataProvider.unsubscribeFromAccountTokenTransfers(e)}unsubscribeFromAllSubscriptions(){this.bridgeComponents.transfersBridgeDataProvider.unsubscribeFromAllSubscriptions()}emitLocalTokenTransferCreated(e){setTimeout(()=>{eA.logger.log("Emitting the tokenTransferCreated event..."),this.events.tokenTransferCreated.emit(e),eA.logger.log("The tokenTransferCreated event has been emitted")},0)}resolveStatusWatcherIfNeeded(e){let t=H.getInitialOperationHash(e),n=this.tokenTransferOperationWatchers.get(t);if(n){for(let[t,r]of n)e.status>=t&&(r.resolve(e),n.delete(t));n.size||this.tokenTransferOperationWatchers.delete(t)}}rejectAndClearAllStatusWatchers(e){for(let t of this.tokenTransferOperationWatchers.values()){for(let n of t.values())n.reject(e);t.clear()}this.tokenTransferOperationWatchers.clear()}attachEvents(){this.bridgeComponents.transfersBridgeDataProvider.events.tokenTransferCreated.addListener(this.handleTransfersBridgeDataProviderTokenTransferCreated),this.bridgeComponents.transfersBridgeDataProvider.events.tokenTransferUpdated.addListener(this.handleTransfersBridgeDataProviderTokenTransferUpdated)}detachEvents(){this.bridgeComponents.transfersBridgeDataProvider.events.tokenTransferUpdated.removeListener(this.handleTransfersBridgeDataProviderTokenTransferUpdated),this.bridgeComponents.transfersBridgeDataProvider.events.tokenTransferCreated.removeListener(this.handleTransfersBridgeDataProviderTokenTransferCreated)}ensureIsNotDisposed(){if(this._isDisposed)throw eA.logger.error("Attempting to call the disposed TokenBridge instance"),new b("TokenBridge is disposed")}async depositUsingWalletApi(e,t,n,r,s){let o="native"===e.type;eA.logger.log("Creating the deposit operation using Wallet API...");let[a,i]=await Promise.all([o?this.bridgeComponents.tezos.wallet.depositNativeToken({amount:t,etherlinkReceiverAddress:n,ticketHelperContractAddress:s}):this.bridgeComponents.tezos.wallet.depositNonNativeToken({token:e,amount:t,etherlinkReceiverAddress:n,ticketHelperContractAddress:s}),this.getTezosConnectedAddress()]);return eA.logger.log("The deposit operation has been created:",a.opHash),{tokenTransfer:{kind:0,status:0,source:i,receiver:n,tezosOperation:{hash:a.opHash,timestamp:new Date().toISOString(),amount:t,token:e}},depositOperation:a}}async depositUsingContractApi(e,t,n,r,s){let o="native"===e.type;eA.logger.log("Creating the deposit operation using Contract API...");let a=await (o?this.bridgeComponents.tezos.depositNativeToken({amount:t,etherlinkReceiverAddress:n,ticketHelperContractAddress:s}):this.bridgeComponents.tezos.depositNonNativeToken({token:e,amount:t,etherlinkReceiverAddress:n,ticketHelperContractAddress:s}));return eA.logger.log("The deposit operation has been created:",a.hash),{tokenTransfer:{kind:0,status:0,source:a.source,receiver:n,tezosOperation:{hash:a.hash,timestamp:new Date().toISOString(),amount:t,token:e}},depositOperation:a}}async getTezosTicketerContent(e){let t=[...Object.values((await this.tezosToolkit.contract.getStorage(e)).content)],n=this.tezosTicketerContentSchema.Encode(t);return"0x"+(0,l.cz)(n,e8).bytes.slice(2)}constructor(e){k(this,"data"),k(this,"stream"),k(this,"bridgeComponents"),k(this,"events",{tokenTransferCreated:new en,tokenTransferUpdated:new en}),k(this,"tezosToolkit"),k(this,"etherlinkToolkit"),k(this,"tezosTicketerContentSchema",new d.V_(e8)),k(this,"tokenTransferOperationWatchers",new Map),k(this,"_isDisposed",!1),k(this,"handleTransfersBridgeDataProviderTokenTransferCreated",e=>{this.events.tokenTransferCreated.emit(e)}),k(this,"handleTransfersBridgeDataProviderTokenTransferUpdated",e=>{this.resolveStatusWatcherIfNeeded(e),this.events.tokenTransferUpdated.emit(e)}),this.tezosToolkit=e.tezos.toolkit,this.etherlinkToolkit=e.etherlink.toolkit;let t=new e6({tezosToolkit:this.tezosToolkit,rollupAddress:e.tezos.bridgeOptions.rollupAddress}),n=new eY({etherlinkToolkit:this.etherlinkToolkit,kernelAddress:e.etherlink.bridgeOptions.kernelAddress,withdrawPrecompileAddress:e.etherlink.bridgeOptions.withdrawPrecompileAddress});this.bridgeComponents={tezos:t,etherlink:n,tokensBridgeDataProvider:e.bridgeDataProviders.tokens,balancesBridgeDataProvider:e.bridgeDataProviders.balances,transfersBridgeDataProvider:e.bridgeDataProviders.transfers},this.data={getBalance:this.getBalance.bind(this),getBalances:this.getBalances.bind(this),getRegisteredTokenPair:this.getRegisteredTokenPair.bind(this),getRegisteredTokenPairs:this.getRegisteredTokenPairs.bind(this),getTokenTransfer:this.getTokenTransfer.bind(this),getTokenTransfers:this.getTokenTransfers.bind(this),getAccountTokenTransfers:this.getAccountTokenTransfers.bind(this)},this.stream={subscribeToTokenTransfer:this.subscribeToTokenTransfer.bind(this),subscribeToTokenTransfers:this.subscribeToTokenTransfers.bind(this),subscribeToAccountTokenTransfers:this.subscribeToAccountTokenTransfers.bind(this),unsubscribeFromTokenTransfer:this.unsubscribeFromTokenTransfer.bind(this),unsubscribeFromTokenTransfers:this.unsubscribeFromTokenTransfers.bind(this),unsubscribeFromAccountTokenTransfers:this.unsubscribeFromAccountTokenTransfers.bind(this),unsubscribeFromAllSubscriptions:this.unsubscribeFromAllSubscriptions.bind(this)},this.attachEvents()}},e7="0x0000000000000000000000000000000000000000",te="0x0000000000000000000000000000000000000040",tt=e=>{e.logging&&(e.logging.logger&&eA.setLogger(e.logging.logger),e.logging.logLevel&&eA.setLogLevel(e.logging.logLevel)),eA.logger.debug("Creating the default token bridge...");let t=new eK(e),n=new e9({tezos:{toolkit:e.tezos.toolkit,bridgeOptions:{rollupAddress:e.tezos.rollupAddress}},etherlink:{toolkit:e.etherlink.toolkit,bridgeOptions:{kernelAddress:e7,withdrawPrecompileAddress:te}},bridgeDataProviders:{tokens:t,balances:t,transfers:t}});return eA.logger.debug("The default token bridge has been created"),n}}}]);